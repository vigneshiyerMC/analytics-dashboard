<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>User-Specific Analytics Report</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <style>
      body {
        background-color: #f9fafb;
      }
      .scrollable-table {
        max-height: 400px;
        overflow-y: auto;
        overflow-x: hidden;
        background-color: white;
      }
      table {
        table-layout: fixed;
        word-wrap: break-word;
      }
      h3 {
        margin-top: 30px;
      }
      .btn-download {
        margin-top: 20px;
      }
      .error-details {
        background-color: #f1f1f1;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body class="container py-5">
    <h2 class="mb-4 text-primary">User-Specific Analytics Report</h2>
    <input type="file" id="csvFile" class="form-control" />
    <div id="user-validation" class="mt-2 text-danger"></div>
    <!-- <button class="btn btn-success btn-download" onclick="downloadReport()">
      Download Report as PNG
    </button> -->
    <hr />
    <div id="report"></div>

    <script>
      document.getElementById("csvFile").addEventListener("change", uploadCSV);

      function uploadCSV(event) {
        const file = event.target.files[0];
        Papa.parse(file, { header: true, complete: validateAndGenerateReport });
      }

      function parseApiEndpoint(apiErrorMetrics) {
        try {
          const json = JSON.parse(apiErrorMetrics);
          return json?.config?.url || "N/A";
        } catch {
          return "N/A";
        }
      }

      function simplifyURL(url) {
        try {
          return new URL(url).pathname;
        } catch {
          return url;
        }
      }

      function validateAndGenerateReport(results) {
        const data = results.data.filter((row) => row["Time"]);
        const users = new Set(data.map((row) => row["Distinct ID"]));
        if (users.size > 1) {
          document.getElementById("user-validation").innerText =
            "Multiple users detected! Please upload data for a single user.";
          document.getElementById("report").innerHTML = "";
        } else {
          document.getElementById("user-validation").innerText = "";
          generateReport(data);
        }
      }

      function generateReport(data) {
        data.sort((a, b) => parseFloat(a.Time) - parseFloat(b.Time));

        const pageViews = data.filter(
          (row) => row["Event Name"] === "[Auto] Page View"
        );
        const moduleCounts = {};
        pageViews.forEach((row) => {
          const path = simplifyURL(row["Current URL"]);
          moduleCounts[path] = (moduleCounts[path] || 0) + 1;
        });

        const apiErrors = data.filter((row) => /api/i.test(row["Event Name"]));
        const uiErrors = data.filter((row) => /ui/i.test(row["Event Name"]));

        document.getElementById("report").innerHTML = `
                <h3>Event Journey Timeline</h3>
                <div class="scrollable-table">
                    <table class="table table-bordered">
                        <tr><th>Timestamp</th><th>Event</th><th>URL</th></tr>
                        ${data
                          .map(
                            (row) =>
                              `<tr><td>${new Date(
                                row.Time * 1000
                              ).toLocaleString()}</td><td>${
                                row["Event Name"]
                              }</td><td>${simplifyURL(
                                row["Current URL"]
                              )}</td></tr>`
                          )
                          .join("")}
                    </table>
                </div>

                <h3>Top Visited Modules</h3>
                <table class="table table-bordered">
                    <tr><th>URL</th><th>Visits</th></tr>
                    ${Object.entries(moduleCounts)
                      .sort((a, b) => b[1] - a[1])
                      .slice(0, 10)
                      .map(
                        ([url, count]) =>
                          `<tr><td>${url}</td><td>${count}</td></tr>`
                      )
                      .join("")}
                </table>

                <h3>API Error Insights</h3>
                <table class="table table-bordered">
                    <tr><th>Event</th><th>API Endpoint</th><th>Occurrences</th></tr>
                    ${apiErrors
                      .map(
                        (row) => `<tr>
                        <td>${row["Event Name"]}</td>
                        <td>${parseApiEndpoint(row.apiErrorMetrics)}</td>
                        <td>1</td>
                    </tr>`
                      )
                      .join("")}
                </table>

                <h3>UI Error Insights</h3>
                <table class="table table-bordered">
                    <tr><th>Event</th><th>URL</th><th>Occurrences</th></tr>
                    ${uiErrors
                      .map(
                        (row) =>
                          `<tr><td>${row["Event Name"]}</td><td>${simplifyURL(
                            row["Current URL"]
                          )}</td><td>1</td></tr>`
                      )
                      .join("")}
                </table>
            `;
      }

      function downloadReport() {
        const reportElement = document.getElementById("report");
        const originalStyle = reportElement.style.overflow;
        reportElement.style.overflow = "visible";

        html2canvas(reportElement, {
          scrollX: 0,
          scrollY: -window.scrollY,
          useCORS: true,
        }).then((canvas) => {
          reportElement.style.overflow = originalStyle;
          const link = document.createElement("a");
          link.download = "user_analytics.png";
          link.href = canvas.toDataURL();
          link.click();
        });
      }
    </script>
  </body>
</html>
